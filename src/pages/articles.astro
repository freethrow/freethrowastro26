---
// Articles page with red background - combines DatoCMS and markdown articles
import PageLayout from '../layouts/PageLayout.astro';
import { getAllArticles } from '../lib/datocms';
import { getMarkdownArticles } from '../lib/markdown';
import { Image } from 'astro:assets';

// Get articles from both sources
const datocmsArticles = await getAllArticles();
const markdownArticles = getMarkdownArticles();

// Format date to show Month/Year
function formatDate(dateString: string) {
  const date = new Date(dateString);
  const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
  const year = date.getFullYear();
  return `${month}/${year}`;
}

// Normalize DatoCMS articles to common format
const normalizedDatocms = datocmsArticles.map((article) => ({
  slug: article.slug,
  title: article.title,
  short: article.short,
  category: article.category?.name || '',
  cover: article.cover?.url || '',
  coverAlt: article.cover?.alt || article.title,
  date: article.date || article._createdAt,
  source: 'datocms' as const,
}));

// Normalize markdown articles to common format
const normalizedMarkdown = markdownArticles.map((article) => ({
  slug: article.slug,
  title: article.title,
  short: article.short,
  category: article.category,
  cover: article.cover,
  coverAlt: article.title,
  date: article.date || '',
  source: 'markdown' as const,
}));

// Combine and sort by date in descending order (most recent first)
const allArticles = [...normalizedDatocms, ...normalizedMarkdown].sort((a, b) => {
  if (!a.date) return 1;
  if (!b.date) return -1;
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});
---

<PageLayout title="Articles" bgColor="var(--color-articles)" textColor="white" transitionName="articles-box">
  <div class="space-y-6">
    {allArticles.map((article) => (
      <article class="bg-white border-4 border-black p-6 relative">
        <div class="absolute top-6 right-6 bg-black text-white px-4 py-2 font-black text-lg border-4 border-black">
          {article.category && `#${article.category} `}{article.date && formatDate(article.date)}
        </div>
        <a href={`/articles/${article.slug}`} class="block group">
          {article.cover && (
            <img
              src={article.cover}
              alt={article.coverAlt}
              class="w-full h-48 object-cover border-4 border-black mb-4"
            />
          )}
          <h2 class="text-3xl font-black mb-4 group-hover:opacity-70 transition-opacity pr-32">
            {article.title}
          </h2>
          <p class="text-lg">{article.short}</p>
        </a>
      </article>
    ))}
  </div>
</PageLayout>
