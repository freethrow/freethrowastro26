---
// Various page - listing all various content items
import PageLayout from '../layouts/PageLayout.astro';
import { getAllVarious } from '../lib/datocms';
import { Image } from 'astro:assets';

const variousItems = await getAllVarious();

// Format date to show Month/Year
function formatDate(dateString: string) {
  const date = new Date(dateString);
  const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase();
  const year = date.getFullYear();
  return `${month}/${year}`;
}
---

<style>
  .progressive-image {
    position: relative;
    overflow: hidden;
  }

  .progressive-image img {
    transition: filter 0.3s ease-out, transform 0.3s ease-out;
  }

  .progressive-image img.loading {
    filter: blur(10px);
    transform: scale(1.05);
  }
</style>

<PageLayout title="Various" bgColor="var(--color-various)" textColor="white" transitionName="various-box" whiteBgOnMobile={true}>
  <div class="space-y-6">
    {variousItems.map((item) => (
      <article
        class="bg-white border-4 border-black p-6 relative"
        transition:name={`various-card-${item.slug}`}
      >
        <div class="absolute top-6 right-6 bg-black text-white px-4 py-2 font-black text-lg border-4 border-black">
          {item.category && `#${item.category.name} `}{formatDate(item.date || item._createdAt)}
        </div>
        <a href={`/various/${item.slug}`} class="block group">
          {item.cover && (
            <div class="progressive-image">
              <Image
                src={item.cover.url}
                alt={item.cover.alt || item.title}
                width={800}
                height={400}
                loading="lazy"
                decoding="async"
                class="w-full h-48 object-cover border-4 border-black mb-4 progressive-img"
                onload="this.classList.remove('loading')"
                transition:name={`various-image-${item.slug}`}
              />
            </div>
          )}
          <h2
            class="text-3xl font-black mb-4 group-hover:opacity-70 transition-opacity pr-32"
            transition:name={`various-title-${item.slug}`}
          >
            {item.title}
          </h2>
          <p class="text-lg">{item.short}</p>
        </a>
      </article>
    ))}
  </div>
</PageLayout>

<script>
  // Progressive image loading - add loading class to images that aren't loaded yet
  const images = document.querySelectorAll('.progressive-img');

  images.forEach((img) => {
    if (img instanceof HTMLImageElement) {
      // If image is not already loaded, add loading class
      if (!img.complete) {
        img.classList.add('loading');
      }

      // Also add event listener as backup
      img.addEventListener('load', () => {
        img.classList.remove('loading');
      });
    }
  });
</script>
